{% extends "dashboard/base.html" %}

{% block content %}

    <div>
        <h1>Home consumption on {{ selected_date }}</h1>
        <h2>Total usage on this day: {{ usage_on_date }} kWh</h2>
        <h2>Total payable on this day: Â£ {{ payable_on_date }}</h2>
        <a
            {% if previous_date %}
                class="btn btn-primary btn-lg"
                href="{% url 'consumption' %}?date={{ previous_date }}"
            {% else %}
                class="btn btn-primary btn-lg disabled"
            {% endif %}
        >
            <-
        </a>
        <a
            {% if next_date %}
                class="btn btn-primary btn-lg"
                href="{% url 'consumption' %}?date={{ next_date }}"
            {% else %}
                class="btn btn-primary btn-lg disabled"
            {% endif %}
        >
            ->
        </a>
    </div>

    <canvas id="chart-payable" width="100%"></canvas>
    <div class="row">
        <div class="col-lg-6">
            <canvas id="chart-consumption" width="100%"></canvas>
        </div>
        <div class="col-lg-6">
            <canvas id="chart-unit-rates" width="100%"></canvas>
        </div>
    </div>

{% endblock content %}

{% block extrascripts %}
    <script id="consumption" data-consumption="{{ consumption_json }}">
        const consumption = JSON.parse(document.getElementById('consumption').dataset.consumption);
        const chartColors = {
            red: 'rgb(255, 99, 132)',
            orange: 'rgb(255, 159, 64)',
            yellow: 'rgb(255, 205, 86)',
            green: 'rgb(75, 192, 192)',
            blue: 'rgb(54, 162, 235)',
            purple: 'rgb(153, 102, 255)',
            grey: 'rgb(201, 203, 207)'
        };

        let consumptionData = [],
            kwhPriceInPence = [],
            amountPayableInPence = [],
            consumptionLabels = [];
        consumption.forEach((c) => {
            consumptionLabels.push(`${c["interval_start"]} to ${c["interval_end"]}`);
            consumptionData.push(c["consumption"]);
            kwhPriceInPence.push(c["value_inc_vat"]);
            amountPayableInPence.push(c["payable_in_pence"]);
        });

        // Consumption chart
        new Chart(document.getElementById('chart-consumption'), {
            type: 'bar',
            data: {
                labels: consumptionLabels,
                datasets: [{
                    backgroundColor: Chart.helpers.color(chartColors.blue).alpha(0.5).rgbString(),
                    label: 'kWh used',
                    data: consumptionData,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });

        // Unit rates chart
        new Chart(document.getElementById('chart-unit-rates'), {
            type: 'bar',
            data: {
                labels: consumptionLabels,
                datasets: [{
                    backgroundColor: Chart.helpers.color(chartColors.red).alpha(0.5).rgbString(),
                    label: 'kWh price in pence',
                    data: kwhPriceInPence,
                    borderWidth: 1,
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });

        // Payable chart
        new Chart(document.getElementById('chart-payable'), {
            type: 'bar',
            data: {
                labels: consumptionLabels,
                datasets: [{
                    backgroundColor: Chart.helpers.color(chartColors.purple).alpha(0.5).rgbString(),
                    label: 'Amount payable in pence',
                    data: amountPayableInPence,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    </script>
{% endblock extrascripts %}
